# 4.3.9.1. Creating an outline

## warning

- アルゴリズムは、コンフォーマンスチェッカやブラウザ拡張などの他のソフトウェアで実装されていますが、現在、グラフィカルブラウザや支援技術のuaでアウトラインアルゴリズムのネイティブ実装は知られていません。
- したがって、アウトラインアルゴリズムは、文書構造をユーザに伝えることに依存することができない。
- 制作者は、文書構造を伝えるために見出しランク（h1〜h6）を使用する必要があります。

***

- このセクションは非規範的です


***

- このセクションでは、セクションコンテンツ要素またはセクションルート要素のアウトラインを作成するためのアルゴリズムを定義します。
- これは、DOMツリーのノード上のウォークの観点から定義され、ツリー順では、各ノードは、ウォーク中入るときと出るときにに訪問される。
- ノードが訪問されるたびに、それは開始イベントまたは終了イベントをトリガするものとして見ることができる。


```javascript
// 例26
// 次の擬似コードの断片は
// ノードツリーを再帰的にトラバースする方法と、
// いつ入力イベントと終了イベントをトリガーするかを例示しています。
// 再帰的なJavaScript実装は、可能な限り、
// JavaScriptの例を参照してください。

visitNode(node)
  onEnter(node)
  child = node.firstChild
  while(child != null)
    visitNode(child)
    child = child.nextSibling
  onExit(node)
```


- セクションコンテンツ要素またはセクションルート要素のアウトラインは、1つ以上の潜在的にネストされたセクションのリストで構成されます。
- アウトラインが作成される要素は、アウトラインの所有者と呼ばれます。

- セクションは元のDOMツリーのいくつかのノードに対応するコンテナです。
- 各セクションには1つの見出しが関連付けられ、さらに多くのネストされたサブセクションを含めることができます。
- また、アウトラインのアルゴリズムは、DOMツリー内の各ノードを特定のセクションおよび潜在的に見出しに関連付けます。
    - アウトラインのセクションは`section`要素ではありませんが、一部はそのような要素に対応している可能性があります
    - 単に概念的なセクションです。


```html
<!-- 例27:
次のマークアップはbodyノード（したがってドキュメント全体）
に対して次のアウトラインが作成されます。-->

<body>
  <h1>A</h1>
  <p>B</p>
  <h2>C</h2>
  <p>D</p>
  <h2>E</h2>
  <p>F</p>
</body>

<!--
1. ボディノード用に作成されたセクション。見出し "A"に関連付けられています。段落「B」にも関連する。
    1. セクションは最初のh2要素を暗示しています。見出し "C"に関連付けられています。
    段落「D」にも関連する。ネストされたセクションはありません。
    2. セクションは2番目のh2要素に含意します。見出し "E"に関連付けられています。
    段落 "F"にも関連する。ネストされたセクションはありません。
-->
```

- 要素のアウトラインを決定するために、セクションコンテンツ要素またはセクションルート要素に根ざしたDOMサブツリーを辿るときに従わなければならないアルゴリズムは、次のとおりです。

1. `current outline owner`をnullにします。 （アウトラインが作成されている要素を保持します）
2. `current section`をnullにします。 （これはセクションへのポインタを保持するので、DOMの要素はすべてセクションに関連付けることができます）。
3. ネスティングを処理する要素を保持するスタックを作成します。このスタックを空に初期化します。
4. アウトラインを作成するサブツリーのルートにあるセクションコンテンツ要素またはセクションルート要素から始めて、DOMをツリー順に辿り、巡回がenterする時、そこからexitするときに、各要素について以下の最初の関連ステップをトリガします。
    - 要素からexitするとき、その要素がスタックの先頭にある要素の場合
        - note: exitされた要素は、見出しコンテンツ要素または隠された属性を持つ要素です
        - その要素をスタックからポップします。
    - スタックの先頭が見出しコンテンツ要素または隠し属性を持つ要素の場合
        - 何もしない
    - 隠し属性を持つ要素をenterするとき
        - enterされた要素をスタックにプッシュします。 （これにより、アルゴリズムはその要素と要素の子孫をスキップします）。
    - セクションコンテンツ要素にenterするとき
        - 以下のステップを実行する
            1. `current outline owner`がnullでない場合は、次のサブステップを実行します。
                1. `current section`に見出しがない場合は、暗黙の見出しを作成し、それを`current section`の見出しとします。
                2. `current outline owner`をスタックにプッシュします。
            2. `current outline owner`をenterされる要素にします。
            3. `current section`を、`current section owner`要素のために新しく作成されたセクションにします。
            4. `current section owner`を`current section`に関連付けます。
            5. アウトラインの唯一のセクションとして、新しい`current section`だけで初期化された、新しい`current section owner`の新しいアウトラインを用意する。
    - セクションコンテンツ要素をexitするとき、スタックが空でない場合
        - 以下のステップを実行する
            1. `current section`に見出しがない場合は、暗黙の見出しを作成し、それを`current section`の見出しとします。
            2. スタックから一番上の要素をポップし、`current outline owner`をその要素にします。
            3. `current section`を`current outline owner`要素のアウトラインの最後のセクションにします。
            4. exitするコンテンツセクションのアウトラインを`current section`に追加します。
                - これはアウトラインの最後のセクションであるセクションを変更しません
    - セクションルート要素にenterするとき
        - 以下のステップを実行する
            1. `current outline owner`がnullでない場合は、`current outline owner`をスタックにプッシュします。
            2. `current outline owner`を入力する要素にします。
            3. `current outline owner`の親セクションを`current section`にします。
            4. `current section`を、`current outline owner`要素のために新しく作成されたセクションにします。
            5. アウトラインの唯一のセクションとして、新しい`current section`だけで初期化された、新しい`current section owner`の新しいアウトラインを用意します。
    - セクションルート要素を終了するときに、スタックが空でない場合
        - 以下のステップを実行する
            1. `current section`に見出しがない場合は、暗黙の見出しを作成し、それを`current section`の見出しとします。
            2. `current section`を`current section owner`の親セクションにします。
            3. スタックから一番上の要素をポップし、`current section owner`をその要素にします。
    - セクションコンテンツ要素またはセクションルート要素をexitするとき（スタックが空のとき）
        - note: `current section owner`は、exitされる要素であり、アウトラインが生成されているサブツリーのルートにあるセクションコンテンツ要素またはセクションルート要素です。
        - `current section`に見出しがない場合は、暗黙の見出しを作成し、それを`current section`の見出しとします。
        - 全ステップの次のステップにスキップしてください。 （巡回は終了）
    - 見出しコンテンツ要素にenterするとき
        - `current section`に見出しがない場合は、enterされる要素を`current section`の見出しにします。
        - それ以外の場合、`current section owner`のアウトラインの最後のセクションの見出しが暗黙の見出しである場合、もしくはenterされた見出しに`current section owner`のアウトラインの最後のセクションの見出し以上のランクがある場合、新しいセクションを作成し、`current outline section`要素のアウトラインに追加して、この新しいセクションがそのアウトラインの最後の新しいセクションになるようにします。
            - `current section`を新しいセクションにします。
            - 入力される要素を`current section`の新しい見出しにします。
        - それ以外の場合は、次のサブステップを実行します。
            1. `candidate section`を`current section`とする
            2. heading loop: enterされた要素のランクが`candidate section`の見出しのランクよりも低い場合は、新しいセクションを作成して`candidate section`に追加します。
                - これはアウトラインの最後のセクションであるセクションを変更しません。
            3. 新しい`candidate section`を、`current section owner`のアウトラインの`candidate section`を含むセクションとする。
            4. `candidate section`を`new candidate section`とする。
            5. heading loopというラベルのステップに戻ります。
        - 入力された要素をスタックにプッシュします。 （これにより、アルゴリズムは要素の子孫をスキップします）。
        - note: h1は最も高いランクを持ち、h6は最も低いランクを持ちます
    - それ以外の場合
        - 何もしない
    - さらに、巡回がノードをexitするたびに、上記の手順を実行した後、ノードがまだセクションに関連付けられていない場合は、ノードを`current section`セクションに関連付けます。

5. アウトラインが作成されているサブツリー内のすべての非要素ノードを、その親要素が関連付けられているセクションに関連付けます。
6. サブツリー内のすべてのノードを、関連付けられているセクションのヘッダーと関連付けます（存在する場合）。


- 上記のアルゴリズムによって作成されたセクションのツリー、またはその適切なサブセットは、たとえば目次を生成するときなどに、ドキュメントアウトラインを生成するときに使用する必要があります。
- ドキュメントのbody要素用に作成されたアウトラインは、ドキュメント全体のアウトラインです。
- セクションが元の文書内の実要素または関連する見出しコンテンツ要素に対して作成された場合、上記のプロセスで見出しのためにツリーのセクションが生成された場合、インタラクティブな目次を作成するとき、エントリはユーザを関連するセクショニングコンテンツ要素にジャンプさせるべき

- note: したがって、文書の最初のセクションを選択すると、本文の最初の見出しがどこにあるかにかかわらず、常にユーザーが文書の先頭に移動します。

- `section`に関連付けられた見出しコンテンツ要素のアウトラインの深さは、ドキュメントの要素のアウトラインが作成されたときにセクションが見つかる最外郭のセクションの祖先であるセクションの数であり、セクションに関連付けられていない見出しコンテンツ要素のアウトラインの深さは1です。

- uaは、セクション見出しが明示されていないセクションに対しては、デフォルトの見出しを提供する必要があります。


```html
<!-- 例28:
以下のスニペットを考えてみましょう。-->
<body>
  <nav>
    <p><a href="/">Home</a></p>
  </nav>
  <p>Hello world.</p>
  <aside>
    <p>My cat is cute.</p>
  </aside>
</body>

<!--
見出しは含まれていませんが、このスニペットには3つのセクションがあります。
2つのサブセクション（navとaside）を持つ文書（body）。uaは、以下のようにアウトラインを提示することができる。
1. Untitled document
    1. Navigation
    2. Sidebar

これらのデフォルト見出し（ "無題ドキュメント"、
"ナビゲーション"、"サイドバー"）は、この仕様では指定されておらず、ユーザーの言語、ページの言語、ユーザーのプリファレンス、ユーザーエージェントの実装者のプリファレンスなどによって異なります。 -->

<!-- 例29:
次のJavaScript関数は、ツリーウォークの実装方法を示しています。
ルート引数は、巡回するツリーのルート（セクションの内容要素またはセクションのルート要素のいずれか）です。
セクションコンテンツ要素またはセクションルート要素のいずれか

ルート引数は、巡回するツリーのルート（セクションの内容要素またはセクションのルート要素のいずれか）です。
exit引数は、ノードの入力時および終了時にコールされるコールバックです。
以下のスニペットを考えてみましょう。-->

function (root, enter, exit) {
  var node = root;
  start: while (node) {
    enter(node);
    if (node.firstChild) {
      node = node.firstChild;
      continue start;
    }
    while (node) {
      exit(node);
      if (node == root) {
        node = null;
      } else if (node.nextSibling) {
        node = node.nextSibling;
        continue start;
      } else {
        node = node.parentNode;
      }
    }
  }
}
```
